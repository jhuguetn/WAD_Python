<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Plugins.MG.Mammo_CDMam.CDMam_lib &mdash; ..  documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="..  documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">..  documentation</a> &raquo;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for Plugins.MG.Mammo_CDMam.CDMam_lib</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">CDMam_lib: classes and routines for calculation of CDMAM scores</span>
<span class="sd">Warning: THIS MODULE EXPECTS PYQTGRAPH DATA: X AND Y ARE TRANSPOSED!</span>

<span class="sd">Some stuff that can be optimized:</span>
<span class="sd"> * choice for detection scale (radius around expectation locations)</span>
<span class="sd"> * choice for integration scale (sigma_bx in blurring/integration)</span>
<span class="sd"> * maybe exclude better influence of text next to boundary cells</span>
<span class="sd"> * maybe crop image to interesting size (before or first step of removal of grid)</span>
<span class="sd"> * speed up removal of grid (maybe with grid detection on lower scale?)</span>

<span class="sd">Changelog:</span>
<span class="sd">    20150826: reshuffling in gridremove to demand less memory (windows cannot cope)</span>
<span class="sd">    20150213: first working version</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage</span> <span class="kn">as</span> <span class="nn">scind</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">wadwrapper_lib</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pyWADLib</span> <span class="kn">import</span> <span class="n">wadwrapper_lib</span>

<span class="kn">import</span> <span class="nn">CDMam_constants</span> <span class="kn">as</span> <span class="nn">lit</span>

<div class="viewcode-block" id="CDMamPhantom"><a class="viewcode-back" href="../../../../Plugins.MG.Mammo_CDMam.html#Plugins.MG.Mammo_CDMam.CDMam_lib.CDMamPhantom">[docs]</a><span class="k">class</span> <span class="nc">CDMamPhantom</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description of the CDMAM Phantom. For now version 3.2 and 3.4 are implemented</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">thickness_um</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">diameter_mm</span>  <span class="o">=</span> <span class="p">[]</span>
    <span class="n">phantomlim</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">humanfactor</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">version</span> <span class="o">=</span> <span class="s">&quot;0.0&quot;</span>

    <span class="c">#</span>
    <span class="c">#GT = 4 1</span>
    <span class="c">#     3 2</span>
    <span class="n">groundtruth</span> <span class="o">=</span> <span class="p">[</span> <span class="c"># for version 3.2 and 3.4</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="c">#3.2</span>
                    <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="c">#2.5</span>
                    <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="c">#2</span>
                    <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="c">#1.6</span>
                    <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="c">#1.25</span>
                    <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="c">#1</span>
                    <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="c">#0.8</span>
                    <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="c">#0.63</span>
                    <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="c">#0.5</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="c">#0.4</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span><span class="c">#0.31</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="c">#0.25</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="c">#0.2</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span><span class="c">#0.16</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="c">#0.13</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="c">#0.1</span>
                    <span class="p">]</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">version</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor of CDMamPhantom. </span>
<span class="sd">        Difference between 3.2 and 3.4 is thickness/diammeter of gold discs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="s">&quot;3.2&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thickness_um</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span><span class="mf">0.13</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span>
                                 <span class="mf">0.31</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">1.25</span><span class="p">,</span> <span class="mf">1.60</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diameter_mm</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.20</span><span class="p">,</span> <span class="mf">2.50</span><span class="p">,</span> <span class="mf">2.00</span><span class="p">,</span> <span class="mf">1.60</span><span class="p">,</span>
                                <span class="mf">1.25</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">,</span>
                                <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.31</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span>
                                <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.13</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">]</span>
            <span class="c"># fit: factor = 2.13036+0.195548*ln(diam-0.0573261)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">humanfactor</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">2.35</span><span class="p">,</span><span class="mf">2.31</span><span class="p">,</span><span class="mf">2.26</span><span class="p">,</span><span class="mf">2.22</span><span class="p">,</span><span class="mf">2.16</span><span class="p">,</span> <span class="c"># values from log fit to published values</span>
                <span class="mf">2.11</span><span class="p">,</span><span class="mf">2.06</span><span class="p">,</span><span class="mf">2.01</span><span class="p">,</span><span class="mf">1.98</span><span class="p">,</span><span class="mf">1.94</span><span class="p">,</span><span class="mf">1.88</span><span class="p">,</span><span class="mf">1.82</span><span class="p">,</span><span class="mf">1.75</span><span class="p">,</span><span class="mf">1.68</span><span class="p">,</span><span class="mf">1.6</span><span class="p">,</span><span class="mf">1.5</span><span class="p">]</span> <span class="c"># published values for 1.00 to 0.08</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">phantomlim</span> <span class="o">=</span> <span class="p">[</span> <span class="c"># diam_mm minthick maxthick</span>
                                <span class="p">[</span><span class="mf">3.20</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">2.50</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">2.00</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">1.60</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.25</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.60</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.63</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.60</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.60</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">,</span> <span class="mf">1.60</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.31</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mf">1.60</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">1.60</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.13</span><span class="p">,</span> <span class="mf">1.60</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mf">1.60</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.13</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">1.60</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">1.25</span><span class="p">],</span>
                                <span class="p">]</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="s">&quot;3.4&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thickness_um</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.13</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span>
                                 <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.36</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.71</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">1.42</span><span class="p">,</span> <span class="mf">2.00</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diameter_mm</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.00</span><span class="p">,</span> <span class="mf">1.60</span><span class="p">,</span> <span class="mf">1.25</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span>
                                <span class="mf">0.31</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.13</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">humanfactor</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">2.26</span><span class="p">,</span><span class="mf">2.22</span><span class="p">,</span><span class="mf">2.16</span><span class="p">,</span> <span class="c"># values from log fit to published values</span>
                <span class="mf">2.11</span><span class="p">,</span><span class="mf">2.06</span><span class="p">,</span><span class="mf">2.01</span><span class="p">,</span><span class="mf">1.98</span><span class="p">,</span><span class="mf">1.94</span><span class="p">,</span><span class="mf">1.88</span><span class="p">,</span><span class="mf">1.82</span><span class="p">,</span><span class="mf">1.75</span><span class="p">,</span><span class="mf">1.68</span><span class="p">,</span><span class="mf">1.6</span><span class="p">,</span><span class="mf">1.5</span><span class="p">,</span><span class="mf">1.4</span><span class="p">,</span> <span class="c"># published values for 1.00 to 0.08</span>
                <span class="mf">0.97</span><span class="p">]</span> <span class="c"># values from log fit to published values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phantomlim</span> <span class="o">=</span> <span class="p">[</span> <span class="c"># diam_mm minthick maxthick</span>
                                <span class="p">[</span><span class="mf">2.00</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">1.60</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.36</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.71</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.63</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">1.42</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">2.00</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">2.00</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.31</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">2.00</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="mf">2.00</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">2.00</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">,</span> <span class="mf">2.00</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.13</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mf">2.00</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">2.00</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.13</span><span class="p">,</span> <span class="mf">2.00</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.06</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mf">1.42</span><span class="p">],</span>
                                <span class="p">]</span>
</div>
<div class="viewcode-block" id="CDMamStruct"><a class="viewcode-back" href="../../../../Plugins.MG.Mammo_CDMam.html#Plugins.MG.Mammo_CDMam.CDMam_lib.CDMamStruct">[docs]</a><span class="k">class</span> <span class="nc">CDMamStruct</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class holding all information for IO between gui and Lib</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="c"># input image</span>
    <span class="n">dcmInfile</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">pixeldataIn</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">imageFileName</span> <span class="o">=</span> <span class="bp">None</span>
    
    <span class="c"># for matlib plotting</span>
    <span class="n">hasmadeplots</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dcmInfile</span><span class="p">,</span><span class="n">pixeldataIn</span><span class="p">,</span><span class="n">phantomversion</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dcmInfile</span> <span class="o">=</span> <span class="n">dcmInfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixeldataIn</span> <span class="o">=</span> <span class="n">pixeldataIn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hasmadeplots</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">phantom</span> <span class="o">=</span> <span class="n">CDMamPhantom</span><span class="p">(</span><span class="n">phantomversion</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gridimage</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startingroi</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># starting box in phantom to find grid coords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gridrois</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># cornerpoints of each grid cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotcount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imnum</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># increasing number for id generation</span>
        
        <span class="c"># main results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diam_mm</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># list of diameters in mm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_um</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># list of predicted human detectable thickness thresholds in um</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iqf</span> <span class="o">=</span> <span class="mf">0.</span> <span class="c"># image quality factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold_fnames</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># images of threshold_thickness</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_fnames</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># images of fits</span>

        <span class="c"># identifiers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtername</span> <span class="o">=</span> <span class="n">lit</span><span class="o">.</span><span class="n">stUnknown</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scannername</span> <span class="o">=</span> <span class="n">lit</span><span class="o">.</span><span class="n">stUnknown</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energypresentation</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
</div>
<div class="viewcode-block" id="CDMam"><a class="viewcode-back" href="../../../../Plugins.MG.Mammo_CDMam.html#Plugins.MG.Mammo_CDMam.CDMam_lib.CDMam">[docs]</a><span class="k">class</span> <span class="nc">CDMam</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for calculation of CDMAM score</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">qcversion</span> <span class="o">=</span> <span class="mi">20150826</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">guimode</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guimode</span> <span class="o">=</span> <span class="n">guimode</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_smoothHitMatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">hitmatrix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Smoothing: kernel = 0.25 0.50 0.25</span>
<span class="sd">                            0.50 1.00 0.50</span>
<span class="sd">                            0.25 0.50 0.25</span>
<span class="sd">        and normalization = sum(kernel_used)</span>
<span class="sd">        at borders, just ignore, so north edge does not include top line of kernel</span>
<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="n">wid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hitmatrix</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">hei</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hitmatrix</span><span class="p">)</span>

        <span class="c"># 1. Smooth found values</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.50</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">smoothhit</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">hitmatrix</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hei</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">wid</span><span class="p">):</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">val</span> <span class="o">=</span><span class="mi">0</span>
                <span class="k">for</span> <span class="n">yi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
                        <span class="n">yy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span><span class="n">yi</span>
                        <span class="n">xx</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span><span class="n">xi</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">yy</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">xx</span> <span class="o">&lt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">yy</span><span class="o">&gt;</span><span class="p">(</span><span class="n">hei</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">xx</span><span class="o">&gt;</span><span class="p">(</span><span class="n">wid</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
                            <span class="k">continue</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">phantom</span><span class="o">.</span><span class="n">groundtruth</span><span class="p">[</span><span class="n">yy</span><span class="p">][</span><span class="n">xx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="n">val</span>   <span class="o">+=</span> <span class="n">kernel</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">hitmatrix</span><span class="p">[</span><span class="n">yy</span><span class="p">][</span><span class="n">xx</span><span class="p">]</span>
                        <span class="n">norm</span>  <span class="o">+=</span> <span class="n">kernel</span><span class="p">[</span><span class="n">yi</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span><span class="n">norm</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
                    <span class="n">smoothhit</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="o">/</span><span class="n">norm</span>
        <span class="k">return</span> <span class="n">smoothhit</span>

    <span class="k">def</span> <span class="nf">_testline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test for changes from 0 to 1, return list of locations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">left</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">left</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">left</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">left</span>

    <span class="k">def</span> <span class="nf">_sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sigmoid function for fitting</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">x0</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">y</span>

    <span class="k">def</span> <span class="nf">_invsigmoid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        inverse sigmoid function for evaluation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">y</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">/</span><span class="n">k</span>
        <span class="k">return</span> <span class="n">x</span>

<div class="viewcode-block" id="CDMam.thresholdThickness"><a class="viewcode-back" href="../../../../Plugins.MG.Mammo_CDMam.html#Plugins.MG.Mammo_CDMam.CDMam_lib.CDMam.thresholdThickness">[docs]</a>    <span class="k">def</span> <span class="nf">thresholdThickness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">hitmatrix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculation of threshold thickness</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phantom</span>    <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">phantom</span>

        <span class="n">diam_mm</span>    <span class="o">=</span> <span class="n">phantom</span><span class="o">.</span><span class="n">diameter_mm</span>
        <span class="n">thick_um</span>   <span class="o">=</span> <span class="n">phantom</span><span class="o">.</span><span class="n">thickness_um</span>
        <span class="n">gtmatrix</span>   <span class="o">=</span> <span class="n">phantom</span><span class="o">.</span><span class="n">groundtruth</span>
        <span class="n">phantomlim</span> <span class="o">=</span> <span class="n">phantom</span><span class="o">.</span><span class="n">phantomlim</span>

        <span class="n">wid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hitmatrix</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">hei</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hitmatrix</span><span class="p">)</span>
        <span class="n">dosmooth</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">dofit</span>    <span class="o">=</span> <span class="bp">True</span>
        <span class="c">#  0 : not defined or no hit</span>
        <span class="c">#  1 : hit</span>
        <span class="c">#  0.5 : switched</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">diams</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">human</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dosmooth</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hei</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">wid</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">hitmatrix</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">45</span><span class="p">):</span>
                        <span class="n">limit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thick_um</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                        <span class="n">diams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diam_mm</span><span class="p">[</span><span class="n">y</span><span class="p">])</span>
                        <span class="n">human</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phantom</span><span class="o">.</span><span class="n">humanfactor</span><span class="p">[</span><span class="n">y</span><span class="p">]</span><span class="o">*</span><span class="n">thick_um</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                        <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">smoothhit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smoothHitMatrix</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">hitmatrix</span><span class="p">)</span>

            <span class="c"># 2. show found values</span>
            <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hei</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">wid</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">gtmatrix</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                            <span class="k">print</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">print</span> <span class="s">&quot;</span><span class="si">%0.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">smoothhit</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">],</span>
                    <span class="k">print</span> <span class="s">&quot;&quot;</span>
                <span class="k">print</span> <span class="s">&quot;&quot;</span>
  
            <span class="k">if</span><span class="p">(</span><span class="n">dofit</span> <span class="o">==</span> <span class="bp">False</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                direct threshold finding</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hei</span><span class="p">):</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">wid</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">smoothhit</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.62</span><span class="p">):</span>
                            <span class="n">found</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="n">limit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thick_um</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                            <span class="k">break</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">found</span> <span class="o">==</span> <span class="bp">False</span><span class="p">):</span>
                        <span class="n">limit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thick_um</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span>
                    <span class="n">human</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phantom</span><span class="o">.</span><span class="n">humanfactor</span><span class="p">[</span><span class="n">y</span><span class="p">]</span><span class="o">*</span><span class="n">limit</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
  
            <span class="k">else</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                fit sigmoid threshold finding</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">thresh</span> <span class="o">=</span> <span class="mf">0.625</span>
                <span class="n">minprop</span> <span class="o">=</span> <span class="mf">0.1</span>
                <span class="n">maxprop</span> <span class="o">=</span> <span class="mf">0.999</span>
  
                <span class="c"># 3. fill arrays of with acceptable datapoints for each diameter</span>
                <span class="n">propsarr</span>  <span class="o">=</span> <span class="p">[]</span>
                <span class="n">thicksarr</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">fitsarr</span>   <span class="o">=</span> <span class="p">[]</span>
                <span class="n">idxarr</span>    <span class="o">=</span> <span class="p">[]</span> <span class="c"># to make sure we know to which diam it belongs</span>
                <span class="n">fitidxs</span>   <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hei</span><span class="p">):</span> <span class="c"># loop over diams</span>
                    <span class="n">props</span>  <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">thicks</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">wid</span><span class="p">):</span> <span class="c"># loop over thickness</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">gtmatrix</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="c"># only points that are in grid</span>
                            <span class="k">continue</span>
                        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">props</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="k">if</span><span class="p">(</span><span class="n">smoothhit</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">thresh</span><span class="p">):</span> <span class="c"># if first point is already larger, stop searching</span>
                                <span class="n">props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smoothhit</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">])</span>
                                <span class="n">thicks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thick_um</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                                <span class="k">break</span>
                            <span class="k">if</span><span class="p">(</span><span class="n">x</span><span class="o">&lt;</span><span class="p">(</span><span class="n">wid</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">smoothhit</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">smoothhit</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="ow">and</span> <span class="n">smoothhit</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">1.</span><span class="p">):</span>
                                <span class="k">continue</span> <span class="c"># ensure we start with increasing props</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">smoothhit</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span><span class="o">&gt;</span><span class="n">maxprop</span><span class="p">):</span> <span class="c"># stop adding points after first 1 is reached</span>
                            <span class="n">props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smoothhit</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">])</span>
                            <span class="n">thicks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thick_um</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                            <span class="k">break</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">smoothhit</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span><span class="o">&gt;</span><span class="n">minprop</span><span class="p">):</span> <span class="c"># only add points with an interesting threshold</span>
                            <span class="n">props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smoothhit</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">])</span>
                            <span class="n">thicks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thick_um</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                    <span class="n">propsarr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">props</span><span class="p">))</span>
                    <span class="n">thicksarr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">thicks</span><span class="p">))</span>
                    <span class="n">idxarr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                    <span class="n">diams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diam_mm</span><span class="p">[</span><span class="n">y</span><span class="p">])</span>
  
  
                <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;thicks&quot;</span>
                    <span class="k">print</span> <span class="n">thicksarr</span>
                    <span class="k">print</span> <span class="s">&quot;props&quot;</span>
                    <span class="k">print</span> <span class="n">propsarr</span>
                    <span class="k">print</span> <span class="s">&quot;done&quot;</span>
  
                <span class="c"># 4. try to sigmoid fit each curve</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">propsarr</span><span class="p">)):</span>
                    <span class="n">props</span>  <span class="o">=</span> <span class="n">propsarr</span><span class="p">[</span><span class="n">y</span><span class="p">]</span>
                    <span class="n">thicks</span> <span class="o">=</span> <span class="n">thicksarr</span><span class="p">[</span><span class="n">y</span><span class="p">]</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">thresh</span><span class="p">):</span> <span class="c"># only point already more than enough</span>
                        <span class="n">limval</span> <span class="o">=</span> <span class="n">thicks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">thicks</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
                            <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">10.</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sigmoid</span><span class="p">,</span> <span class="n">thicks</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span><span class="n">diag</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">thicks</span><span class="p">),</span> <span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">props</span><span class="p">)))</span>
                                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pcov</span><span class="p">)</span><span class="o">==</span><span class="nb">float</span> <span class="ow">and</span> <span class="n">pcov</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
                                    <span class="k">print</span> <span class="s">&quot;ERROR sigmacurve fitting (pcov = inf)&quot;</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">fitsarr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">popt</span><span class="p">)</span>
                                    <span class="n">fitidxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                                    <span class="n">limval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invsigmoid</span><span class="p">(</span><span class="n">thresh</span><span class="p">,</span><span class="o">*</span><span class="n">popt</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">print</span> <span class="s">&quot;ERROR sigmacurve fitting (no convergence, try larger guess)&quot;</span>
  
                        <span class="k">elif</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">thicks</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
                            <span class="k">if</span><span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">thresh</span><span class="p">):</span> <span class="c"># only point already more than enough</span>
                                <span class="n">limval</span> <span class="o">=</span> <span class="n">thicks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">limval</span> <span class="o">=</span> <span class="n">phantomlim</span><span class="p">[</span><span class="n">idxarr</span><span class="p">[</span><span class="n">y</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span> <span class="c"># only point not enough, should put it to max</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span><span class="p">(</span><span class="n">minprop</span><span class="o">&gt;=</span><span class="n">thresh</span><span class="p">):</span>
                                <span class="n">limval</span> <span class="o">=</span> <span class="n">phantomlim</span><span class="p">[</span><span class="n">idxarr</span><span class="p">[</span><span class="n">y</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span> <span class="c"># minprop set to high</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">limval</span> <span class="o">=</span> <span class="n">phantomlim</span><span class="p">[</span><span class="n">idxarr</span><span class="p">[</span><span class="n">y</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span> <span class="c"># should never be the case</span>
                    <span class="n">limit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">limval</span><span class="p">)</span>
                    <span class="n">human</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phantom</span><span class="o">.</span><span class="n">humanfactor</span><span class="p">[</span><span class="n">idxarr</span><span class="p">[</span><span class="n">y</span><span class="p">]]</span><span class="o">*</span><span class="n">limval</span><span class="p">)</span>
  
        <span class="n">cs</span><span class="o">.</span><span class="n">iqf</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">diam_mm</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">limit_um</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">diams</span><span class="p">,</span><span class="n">limit</span><span class="p">):</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">iqf</span> <span class="o">+=</span> <span class="n">d</span><span class="o">*</span><span class="n">t</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">diam_mm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">limit_um</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;diam_mm&quot;</span><span class="p">,</span><span class="s">&quot;limit_um&quot;</span>
            <span class="k">for</span> <span class="n">d</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">diams</span><span class="p">,</span><span class="n">limit</span><span class="p">):</span>
                <span class="k">print</span> <span class="n">d</span><span class="p">,</span><span class="n">t</span>
            <span class="k">print</span> <span class="s">&quot;iqf&quot;</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">iqf</span>
  
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">diams</span><span class="p">,</span><span class="n">limit</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;automatic&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">diams</span><span class="p">,</span><span class="n">human</span><span class="p">,</span><span class="s">&#39;c&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;pred. human&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;threshold thickness [um]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;diameter [mm]&quot;</span><span class="p">)</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">hasmadeplots</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c"># diammm accept achiev</span>
        <span class="n">protlim</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="mf">2.00</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.0380</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.0910</span><span class="p">,</span> <span class="mf">0.0560</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.1500</span><span class="p">,</span> <span class="mf">0.1030</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.3520</span><span class="p">,</span> <span class="mf">0.2440</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">1.6800</span><span class="p">,</span> <span class="mf">1.1000</span><span class="p">]</span>
        <span class="p">]</span>
  
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">protlim</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">protlim</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;acceptable&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">protlim</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">protlim</span><span class="p">)[:,</span><span class="mi">2</span><span class="p">],</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;achievable&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phantomlim</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phantomlim</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;--k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;phantom limit&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phantomlim</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phantomlim</span><span class="p">)[:,</span><span class="mi">2</span><span class="p">],</span><span class="s">&#39;--k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;phantom limit&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">guimode</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s">&#39;threshold_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">imnum</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;.jpg&#39;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">threshold_fnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        
        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fitsarr</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">clist</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;c&#39;</span><span class="p">,</span><span class="s">&#39;m&#39;</span><span class="p">,</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">]</span>
            <span class="n">sym</span> <span class="o">=</span> <span class="s">&#39;o&#39;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;thickness [um]&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;probability&quot;</span><span class="p">)</span>
            <span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fitsarr</span><span class="p">)):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">fitidxs</span><span class="p">[</span><span class="n">y</span><span class="p">]</span>
                <span class="n">xarr</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">yarr</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">thsim</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">wid</span><span class="p">):</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">gtmatrix</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">x</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">xarr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smoothhit</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">x</span><span class="p">])</span>
                    <span class="n">yarr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thick_um</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

                <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigmoid</span><span class="p">(</span><span class="n">thsim</span><span class="p">,</span><span class="o">*</span><span class="p">(</span><span class="n">fitsarr</span><span class="p">[</span><span class="n">y</span><span class="p">]))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">yarr</span><span class="p">,</span><span class="n">xarr</span><span class="p">,</span><span class="n">sym</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">diam_mm</span><span class="p">[</span><span class="n">idx</span><span class="p">]),</span><span class="n">color</span><span class="o">=</span><span class="n">clist</span><span class="p">[</span><span class="n">cx</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">thsim</span><span class="p">,</span><span class="n">vals</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">clist</span><span class="p">[</span><span class="n">cx</span><span class="p">])</span>
                <span class="n">cx</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">cx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">clist</span><span class="p">):</span> 
                    <span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">sym</span> <span class="o">=</span> <span class="s">&#39;d&#39;</span>
                
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">10.</span><span class="p">],[</span><span class="n">thresh</span><span class="p">,</span><span class="n">thresh</span><span class="p">],</span><span class="s">&#39;--k&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s">&#39;log&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">guimode</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s">&#39;fit_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">imnum</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;.jpg&#39;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">fit_fnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
  </div>
<div class="viewcode-block" id="CDMam.pixDim"><a class="viewcode-back" href="../../../../Plugins.MG.Mammo_CDMam.html#Plugins.MG.Mammo_CDMam.CDMam_lib.CDMam.pixDim">[docs]</a>    <span class="k">def</span> <span class="nf">pixDim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pix_mm</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">dcmInfile</span><span class="o">.</span><span class="n">PixelSpacing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">pix_mm</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">dcmInfile</span><span class="o">.</span><span class="n">ImagerPixelSpacing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pix_mm</span>
</div>
<div class="viewcode-block" id="CDMam.removeGrid"><a class="viewcode-back" href="../../../../Plugins.MG.Mammo_CDMam.html#Plugins.MG.Mammo_CDMam.CDMam_lib.CDMam.removeGrid">[docs]</a>    <span class="k">def</span> <span class="nf">removeGrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">removeGrid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detect the grid of the phantom and remove it from the image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">pixDim</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span>
        
        <span class="c"># try to find a threshold on pixelvalue to define a value representing the grid</span>
        <span class="n">maskval</span> <span class="o">=</span> <span class="mf">0.75</span><span class="o">*</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="c"># make a mask of grid-like values</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span> <span class="o">&lt;</span> <span class="n">maskval</span><span class="p">)</span>

        <span class="c"># hole closing of the mask</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">binary_closing</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="n">structure</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">binary_opening</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="n">structure</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">binary_dilation</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="c"># new since 20150211</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">binary_dilation</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

        <span class="c"># fill the gridlines with the median values of the pixels around it</span>
        <span class="n">medimage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">,</span><span class="n">shift</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="o">+</span><span class="n">mask</span><span class="o">*</span><span class="p">(</span><span class="n">medimage</span><span class="o">-</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">)</span>
        <span class="c"># repeat to remove propagated mask # new since 20150211</span>
        <span class="n">medimage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span><span class="n">shift</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="o">+</span><span class="n">mask</span><span class="o">*</span><span class="p">(</span><span class="n">medimage</span><span class="o">-</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">)</span>
        <span class="n">medimage</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">gridimage</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c"># find gridobject</span>
        <span class="n">gridobject</span>         <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">binary_fill_holes</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">gridimage</span><span class="p">)</span>
        <span class="n">label_im</span><span class="p">,</span><span class="n">nb_labels</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">gridobject</span><span class="p">)</span>
        <span class="n">sizes</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gridobject</span><span class="p">,</span> <span class="n">label_im</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_labels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">gridobject</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c">#Clean up small connect components:</span>
        <span class="n">mask_size</span> <span class="o">=</span> <span class="n">sizes</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span> <span class="c">#(100/self.pixDim())**2</span>
        <span class="n">remove_pixel</span> <span class="o">=</span> <span class="n">mask_size</span><span class="p">[</span><span class="n">label_im</span><span class="p">]</span>
        <span class="n">label_im</span><span class="p">[</span><span class="n">remove_pixel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c"># Now reassign labels with np.searchsorted:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">label_im</span><span class="p">)</span>
        <span class="n">label_im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">label_im</span><span class="p">)</span>

        <span class="n">medimage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span><span class="n">shift</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">dest</span> <span class="o">+=</span> <span class="n">cs</span><span class="o">.</span><span class="n">gridimage</span><span class="o">*</span><span class="p">(</span><span class="n">medimage</span><span class="o">-</span><span class="n">dest</span><span class="p">)</span>
        <span class="n">medimage</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">gridimage</span> <span class="o">*=</span> <span class="n">label_im</span>
        <span class="k">if</span> <span class="o">-</span><span class="mi">1</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="c"># remove everything outside grid</span>
            <span class="n">wid</span> <span class="o">=</span> <span class="n">dest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">hei</span> <span class="o">=</span> <span class="n">dest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">mv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dest</span><span class="p">[</span><span class="n">wid</span><span class="o">/</span><span class="mi">4</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">wid</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span><span class="n">hei</span><span class="o">/</span><span class="mi">4</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">hei</span><span class="o">/</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">dest</span> <span class="o">=</span> <span class="n">label_im</span><span class="o">*</span><span class="p">(</span><span class="n">dest</span><span class="o">-</span><span class="n">mv</span><span class="p">)</span><span class="o">+</span><span class="n">mv</span>

        <span class="k">if</span> <span class="n">removeGrid</span><span class="p">:</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span> <span class="o">=</span> <span class="n">dest</span>
</div>
<div class="viewcode-block" id="CDMam.findStartingCell"><a class="viewcode-back" href="../../../../Plugins.MG.Mammo_CDMam.html#Plugins.MG.Mammo_CDMam.CDMam_lib.CDMam.findStartingCell">[docs]</a>    <span class="k">def</span> <span class="nf">findStartingCell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find first gridcell for gridcell locating.</span>
<span class="sd">        Required: </span>
<span class="sd">          1. in image onscreen, phantom is located at lefthand side, with radboud logo in lower right corner, </span>
<span class="sd">            with the irradiated area which is not covered by the phantom on the righthand side</span>
<span class="sd">          2. uncovered detector area has higher pixel value than covered area</span>
<span class="sd">          3. Phantom 3.2 cell is 1cm by 1 cm, approx 45 deg rotated. </span>
<span class="sd">        Workflow:</span>
<span class="sd">        1. Find in gridlines image the first row with four crossings from non-grid to grid.</span>
<span class="sd">        2. top corner of first cell is mid of the last two crossings</span>
<span class="sd">        3. Other points from  cell is 1cm by 1 cm, approx 45 deg rotated</span>
<span class="sd">        4. Look for max in small area around each of the four cornerpoints</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pixel_spacing</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixDim</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span> <span class="c"># spacing in mm</span>
        <span class="n">hei</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">roipts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hei</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_testline</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">gridimage</span><span class="p">[:,</span><span class="n">y</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span><span class="nb">int</span><span class="p">((</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span><span class="p">),</span><span class="n">y</span><span class="p">]</span> <span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">roipts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Error! Could not find starting cell. Either grid not properly detected, or phantom rotation too large!&quot;</span>
            <span class="k">return</span> <span class="n">roipts</span>

        <span class="c"># half the length of the hypothenusa of a 90 deg triangle of sides 1 cm</span>
        <span class="n">boxstep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">10.</span><span class="o">/</span><span class="n">pixel_spacing</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">roipts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">roipts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x0</span><span class="o">+</span><span class="n">boxstep</span><span class="p">,</span><span class="n">y0</span><span class="o">+</span><span class="n">boxstep</span><span class="p">])</span>
        <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">boxstep</span><span class="p">])</span>
        <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x0</span><span class="o">-</span><span class="n">boxstep</span><span class="p">,</span><span class="n">y0</span><span class="o">+</span><span class="n">boxstep</span><span class="p">])</span>
        
        <span class="n">roipts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AlignROI</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">roipts</span><span class="p">,</span> <span class="n">distmm</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">roipts</span>
    </div>
<div class="viewcode-block" id="CDMam.CDMamSingle"><a class="viewcode-back" href="../../../../Plugins.MG.Mammo_CDMam.html#Plugins.MG.Mammo_CDMam.CDMam_lib.CDMam.CDMamSingle">[docs]</a>    <span class="k">def</span> <span class="nf">CDMamSingle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate score for one CDMam image</span>
<span class="sd">        WorkFlow:</span>
<span class="sd">        1. Extract grid from image (will be used to define regions of interest for observer)</span>
<span class="sd">        2. Find starting grid cell</span>
<span class="sd">        3. Locate all gridcells</span>
<span class="sd">        4. Test observer on each cell</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotcount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">angledeg</span> <span class="o">=</span> <span class="mf">45.</span>
        <span class="n">fudge</span> <span class="o">=</span> <span class="mf">0.97</span>
        <span class="n">cos_a</span> <span class="o">=</span> <span class="n">fudge</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angledeg</span><span class="o">/</span><span class="mf">180.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">sin_a</span> <span class="o">=</span> <span class="n">fudge</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angledeg</span><span class="o">/</span><span class="mf">180.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">offsetmm_x</span> <span class="o">=</span> <span class="mf">94.</span>
        <span class="n">offsetmm_y</span> <span class="o">=</span> <span class="mf">15.</span>

        <span class="c">#1. remove the grid for will be used to define regions of interest for observer</span>
        <span class="n">removeGridFromPixelData</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># for displaying only on gridless phantom</span>
        <span class="k">print</span> <span class="s">&quot;1/4: removing grid....&quot;</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removeGrid</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">removeGridFromPixelData</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;done&quot;</span>
        
        <span class="k">print</span> <span class="s">&quot;2/4: find starting grid cell....&quot;</span><span class="p">,</span>
        <span class="c">#2. First find some coordinate system om phantom</span>
        <span class="n">pixel_spacing</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixDim</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span> <span class="c"># spacing in mm</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">startingroi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findStartingCell</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;done&quot;</span>
            
        <span class="c">#3. Locate all gridcells</span>
        <span class="k">print</span> <span class="s">&quot;3/4: locating all grid cells....&quot;</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locateGridCells</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;done&quot;</span>

        <span class="c">#4. Test observer on each cell</span>
        <span class="k">print</span> <span class="s">&quot;4/4: modelobserver for each grid cell....&quot;</span><span class="p">,</span>
        <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observerScore</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;done&quot;</span>

        <span class="k">return</span> <span class="n">score</span>
    </div>
<div class="viewcode-block" id="CDMam.CDCOMSingle"><a class="viewcode-back" href="../../../../Plugins.MG.Mammo_CDMam.html#Plugins.MG.Mammo_CDMam.CDMam_lib.CDMam.CDCOMSingle">[docs]</a>    <span class="k">def</span> <span class="nf">CDCOMSingle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        run cdcom.exe on given file</span>
<span class="sd">        input matrix.inp and matrix2.inp, and average</span>
<span class="sd">        (matrix2.inp should be matrix.inp after plain_nnc; avg shouldbe matrix.inp after my ncc, but this is not the case)</span>
<span class="sd">        run ncc</span>
<span class="sd">        calc threshold thickness</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># first clean up output of previous runs</span>
        <span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;matrix.inp&quot;</span><span class="p">,</span><span class="s">&quot;matrix2.inp&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span><span class="n">g</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c"># run cdcom on new file</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span><span class="s">&quot;cdcom.exe&quot;</span><span class="p">),</span><span class="n">cs</span><span class="o">.</span><span class="n">imageFileName</span><span class="p">]</span>
        <span class="k">print</span> <span class="n">cmd</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fnull</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">fnull</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">fnull</span><span class="p">)</span>

        <span class="c"># import cdcom output</span>
        <span class="n">score</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">phantom</span><span class="o">.</span><span class="n">groundtruth</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span><span class="n">fn</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">autostrip</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s">&quot;  &quot;</span><span class="p">)</span>
            <span class="n">dascore</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="c"># transform score:</span>
            <span class="c"># undef: input -1 -&gt; output 0</span>
            <span class="c"># miss : input  2 -&gt; output 0</span>
            <span class="c"># hit  : input  1 -&gt; output 1</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dascore</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dascore</span><span class="p">[</span><span class="n">y</span><span class="p">])):</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">dascore</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">score</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span>

            <span class="k">try</span><span class="p">:</span> <span class="c"># clean up</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span><span class="n">fn</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>


        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">di</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">phantom</span><span class="o">.</span><span class="n">diameter_mm</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">phantom</span><span class="o">.</span><span class="n">thickness_um</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">phantom</span><span class="o">.</span><span class="n">groundtruth</span><span class="p">[</span><span class="n">di</span><span class="p">][</span><span class="n">th</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                        <span class="k">print</span> <span class="s">&quot;    &quot;</span><span class="p">,</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&quot;</span><span class="si">%0.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">score</span><span class="p">[</span><span class="n">di</span><span class="p">][</span><span class="n">th</span><span class="p">],</span>
                <span class="k">print</span> <span class="s">&quot;&quot;</span>
            <span class="k">print</span> <span class="s">&quot;&quot;</span>


        <span class="k">return</span> <span class="n">score</span>

</div>
<div class="viewcode-block" id="CDMam.observerScore"><a class="viewcode-back" href="../../../../Plugins.MG.Mammo_CDMam.html#Plugins.MG.Mammo_CDMam.CDMam_lib.CDMam.observerScore">[docs]</a>    <span class="k">def</span> <span class="nf">observerScore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate score of model observer:</span>
<span class="sd">        Workflow: </span>
<span class="sd">          1. is max response in cell in the correct corner?</span>
<span class="sd">          2. consistency fix of scoring sheet</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span>   <span class="s">&#39;diam_mm&#39;</span><span class="p">,</span><span class="s">&#39;scale_mm2pix&#39;</span><span class="p">,</span> <span class="s">&#39;diam_mm*scale_mm2pix&#39;</span><span class="p">,</span> <span class="s">&#39;sigma_px&#39;</span><span class="p">,</span><span class="s">&#39;rad_px&#39;</span>

        <span class="c">#1. is max response in cell in the correct corner?</span>
        <span class="n">GT</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">phantom</span><span class="o">.</span><span class="n">groundtruth</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">GT</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">di</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">phantom</span><span class="o">.</span><span class="n">diameter_mm</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">phantom</span><span class="o">.</span><span class="n">thickness_um</span><span class="p">)):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">GT</span><span class="p">[</span><span class="n">di</span><span class="p">][</span><span class="n">th</span><span class="p">]</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
                    <span class="n">score</span><span class="p">[</span><span class="n">di</span><span class="p">][</span><span class="n">th</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detectVarGauss</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">di</span><span class="p">,</span><span class="n">th</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">di</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">phantom</span><span class="o">.</span><span class="n">diameter_mm</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">phantom</span><span class="o">.</span><span class="n">thickness_um</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">GT</span><span class="p">[</span><span class="n">di</span><span class="p">][</span><span class="n">th</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                        <span class="k">print</span> <span class="s">&quot; &quot;</span><span class="p">,</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">print</span> <span class="n">score</span><span class="p">[</span><span class="n">di</span><span class="p">][</span><span class="n">th</span><span class="p">],</span>
                <span class="k">print</span> <span class="s">&quot;&quot;</span>
            <span class="k">print</span> <span class="s">&quot;&quot;</span>

        <span class="c"># 2. consistency fix of scoring sheet</span>
        <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nearestNeighborCorrection</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">score</span><span class="p">)</span>
        <span class="c">#score = (np.zeros(np.shape(cs.phantom.groundtruth),dtype=float)).tolist()</span>
        <span class="k">return</span> <span class="n">score</span>
    
    </div>
<div class="viewcode-block" id="CDMam.locateGridCells"><a class="viewcode-back" href="../../../../Plugins.MG.Mammo_CDMam.html#Plugins.MG.Mammo_CDMam.CDMam_lib.CDMam.locateGridCells">[docs]</a>    <span class="k">def</span> <span class="nf">locateGridCells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starting from one a given box, locate all gridcells, using the previous one as a starting point.</span>
<span class="sd">        This way local deformations will not lead to mismatches further away/</span>
<span class="sd">        Returns a matrix or roicornerpoints in cs.gridrois</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">roipts_orig</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">startingroi</span>
        <span class="n">xstep_dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">roipts_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">roipts_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">xstep_dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">roipts_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">roipts_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ystep_dx</span> <span class="o">=</span> <span class="o">-</span><span class="n">xstep_dy</span>
        <span class="n">ystep_dy</span> <span class="o">=</span>  <span class="n">xstep_dx</span>

        <span class="n">x0</span> <span class="o">=</span> <span class="n">roipts_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="o">-</span> <span class="mi">1</span><span class="o">*</span><span class="n">xstep_dx</span><span class="o">-</span><span class="mi">0</span><span class="o">*</span><span class="n">ystep_dx</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">roipts_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>  <span class="o">-</span> <span class="mi">1</span><span class="o">*</span><span class="n">xstep_dx</span><span class="o">-</span><span class="mi">0</span><span class="o">*</span><span class="n">ystep_dy</span>

        <span class="c">#print x0,y0,xstep_dx,xstep_dy,ystep_dx,ystep_dy</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        GT = 4 1</span>
<span class="sd">             3 2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">GT</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">phantom</span><span class="o">.</span><span class="n">groundtruth</span>

        <span class="n">cs</span><span class="o">.</span><span class="n">gridrois</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">di</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">phantom</span><span class="o">.</span><span class="n">diameter_mm</span><span class="p">)):</span>
            <span class="n">lineroi</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">phantom</span><span class="o">.</span><span class="n">thickness_um</span><span class="p">)):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">GT</span><span class="p">[</span><span class="n">di</span><span class="p">][</span><span class="n">th</span><span class="p">]</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">th</span> <span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">di</span> <span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">lineroi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">cs</span><span class="o">.</span><span class="n">gridrois</span><span class="p">[</span><span class="n">di</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">th</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
                        <span class="n">nwpts</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">nwpts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">lineroi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">xstep_dx</span><span class="p">,</span><span class="n">lineroi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">xstep_dy</span><span class="p">])</span>
                        <span class="n">nwpts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AlignROI</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">nwpts</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
                        <span class="n">roipts</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lineroi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">gridrois</span><span class="p">[</span><span class="n">di</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">th</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nwpts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lineroi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">elif</span><span class="p">(</span><span class="n">th</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">lineroi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
                        <span class="n">nwpts</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">nwpts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">lineroi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">xstep_dx</span><span class="p">,</span><span class="n">lineroi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">xstep_dy</span><span class="p">])</span>
                        <span class="n">nwpts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">lineroi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">xstep_dx</span><span class="p">,</span><span class="n">lineroi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">xstep_dy</span><span class="p">])</span>
                        <span class="n">nwpts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AlignROI</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">nwpts</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
                        <span class="n">roipts</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lineroi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nwpts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nwpts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lineroi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">elif</span><span class="p">(</span><span class="n">di</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">cs</span><span class="o">.</span><span class="n">gridrois</span><span class="p">[</span><span class="n">di</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">th</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
                        <span class="n">nwpts</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">nwpts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cs</span><span class="o">.</span><span class="n">gridrois</span><span class="p">[</span><span class="n">di</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">th</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">ystep_dx</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">gridrois</span><span class="p">[</span><span class="n">di</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">th</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">ystep_dy</span><span class="p">])</span>
                        <span class="n">nwpts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cs</span><span class="o">.</span><span class="n">gridrois</span><span class="p">[</span><span class="n">di</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">th</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">ystep_dx</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">gridrois</span><span class="p">[</span><span class="n">di</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">th</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">ystep_dy</span><span class="p">])</span>
                        <span class="n">nwpts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AlignROI</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">nwpts</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
                        <span class="n">roipts</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">gridrois</span><span class="p">[</span><span class="n">di</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">th</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
                        <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">gridrois</span><span class="p">[</span><span class="n">di</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">th</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nwpts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nwpts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">roipts</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="p">(</span><span class="n">th</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">xstep_dx</span><span class="o">+</span><span class="p">(</span><span class="n">di</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">ystep_dx</span><span class="o">+.</span><span class="mi">5</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">y0</span><span class="o">+</span><span class="p">(</span><span class="n">th</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">xstep_dy</span><span class="o">+</span><span class="p">(</span><span class="n">di</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">ystep_dy</span><span class="p">)])</span>
                        <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="p">(</span><span class="n">th</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">xstep_dx</span><span class="o">+</span><span class="p">(</span><span class="n">di</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">ystep_dx</span><span class="o">+.</span><span class="mi">5</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">y0</span><span class="o">+</span><span class="p">(</span><span class="n">th</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">xstep_dy</span><span class="o">+</span><span class="p">(</span><span class="n">di</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">ystep_dy</span><span class="p">)])</span>
                        <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="p">(</span><span class="n">th</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">xstep_dx</span><span class="o">+</span><span class="p">(</span><span class="n">di</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ystep_dx</span><span class="o">+.</span><span class="mi">5</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">y0</span><span class="o">+</span><span class="p">(</span><span class="n">th</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">xstep_dy</span><span class="o">+</span><span class="p">(</span><span class="n">di</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ystep_dy</span><span class="p">)])</span>
                        <span class="n">roipts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="p">(</span><span class="n">th</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">xstep_dx</span><span class="o">+</span><span class="p">(</span><span class="n">di</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ystep_dx</span><span class="o">+.</span><span class="mi">5</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">y0</span><span class="o">+</span><span class="p">(</span><span class="n">th</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">xstep_dy</span><span class="o">+</span><span class="p">(</span><span class="n">di</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ystep_dy</span><span class="p">)])</span>
                        <span class="n">roipts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AlignROI</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">roipts</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

                    <span class="n">lineroi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">roipts</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lineroi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">gridrois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">lineroi</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="CDMam.AlignROI"><a class="viewcode-back" href="../../../../Plugins.MG.Mammo_CDMam.html#Plugins.MG.Mammo_CDMam.CDMam_lib.CDMam.AlignROI">[docs]</a>    <span class="k">def</span> <span class="nf">AlignROI</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span><span class="n">roipts</span><span class="p">,</span><span class="n">distmm</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Moves the four cornerpoints of a ROI to the most likely crossing in the gridimage, within &lt;distmm&gt; distance from the starting point.</span>
<span class="sd">        Returns four adjusted cornerpoints.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pix2phantommm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixDim</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
        <span class="n">searchrad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">distmm</span><span class="o">/</span><span class="n">pix2phantommm</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">searchrad</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">searchrad</span><span class="p">)</span>
        <span class="n">widthpx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c">## width/height in pixels</span>
        <span class="n">heightpx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">conf_pts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">conf_pts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">roipts</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span> <span class="c">#6</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">roipts</span><span class="p">)):</span>
                <span class="n">rp</span> <span class="o">=</span> <span class="n">roipts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">minx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">x0</span><span class="o">-</span><span class="n">searchrad</span><span class="p">)</span>
                <span class="n">maxx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">widthpx</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">x0</span><span class="o">+</span><span class="n">searchrad</span><span class="p">)</span>
                <span class="n">y0</span> <span class="o">=</span> <span class="n">rp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">miny</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">y0</span><span class="o">-</span><span class="n">searchrad</span><span class="p">)</span>
                <span class="n">maxy</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">heightpx</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">y0</span><span class="o">+</span><span class="n">searchrad</span><span class="p">)</span>
                <span class="n">cropped</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">gridimage</span><span class="p">[</span><span class="n">minx</span><span class="p">:</span><span class="n">maxx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">miny</span><span class="p">:</span><span class="n">maxy</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="c"># smoothing to get rig of noise</span>
                <span class="n">sigma</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span><span class="n">cropped</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">8.</span><span class="p">)</span>
                <span class="n">cropped</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">cropped</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span> <span class="n">sigma</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;constant&#39;</span><span class="p">)</span>
                <span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">cropped</span><span class="o">.</span><span class="n">argmax</span><span class="p">(),</span><span class="n">cropped</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">x1</span> <span class="o">+=</span> <span class="n">minx</span>
                <span class="n">y1</span> <span class="o">+=</span> <span class="n">miny</span>
                <span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x1</span>
                <span class="n">rp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y1</span>
            <span class="n">searchrad</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">searchrad</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">roipts</span>
</div>
<div class="viewcode-block" id="CDMam.nearestNeighborCorrection"><a class="viewcode-back" href="../../../../Plugins.MG.Mammo_CDMam.html#Plugins.MG.Mammo_CDMam.CDMam_lib.CDMam.nearestNeighborCorrection">[docs]</a>    <span class="k">def</span> <span class="nf">nearestNeighborCorrection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">scorematrix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Nearest Neighbor Correction.</span>
<span class="sd">        From the CDMAM manual:</span>
<span class="sd">            1. A True needs 2 or more correctly indicated nearest neighbours to remain a True</span>
<span class="sd">            2. A False or Not indicated disk will be considered as True when it has 3 or 4 correctly indicated nearest neighbours.</span>
<span class="sd">            3. A True which has only 2 nearest neighbours (at the edges of the phantom) needs only 1 correctly indicated nearest neighbour to remain True.</span>
<span class="sd">            4. A False or Not indicated disk which has only 2 nearest neighbours will be regarded True if both nearest neighbours are correctly indicated.</span>
<span class="sd">            5. The absent corners of the phantom (0.03 mm/2.0 mm and 2.00mm/0.06 mm) will be regarded True when both nearest neighbours are correctly indicated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gtmatrix</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">phantom</span><span class="o">.</span><span class="n">groundtruth</span>
        <span class="n">wid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gtmatrix</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">hei</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gtmatrix</span><span class="p">)</span>
        <span class="c">#  0 : not defined or no hit</span>
        <span class="c">#  1 : hit</span>
        <span class="c">#  0.5 : flipped</span>
        <span class="n">hitmatrix</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">scorematrix</span><span class="p">)</span>
        <span class="n">nn</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hei</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">wid</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">gtmatrix</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">trues</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nn</span><span class="p">:</span>
                    <span class="n">x1</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">y1</span> <span class="o">=</span> <span class="n">y</span><span class="o">+</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">x1</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">y1</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">x1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">wid</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">y1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">hei</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">gtmatrix</span><span class="p">[</span><span class="n">y1</span><span class="p">][</span><span class="n">x1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">scorematrix</span><span class="p">[</span><span class="n">y1</span><span class="p">][</span><span class="n">x1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">trues</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span><span class="p">(</span><span class="n">scorematrix</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span> <span class="c"># True</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="o">&gt;</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">trues</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">count</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">trues</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">):</span> <span class="c"># rule1: True needs at least 2 nn Trues</span>
                        <span class="n">hitmatrix</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
                <span class="k">elif</span><span class="p">(</span><span class="n">scorematrix</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="c"># False</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="o">&gt;</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">trues</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">count</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">trues</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span> <span class="c"># rule2: False needs at least 3 nn Trues</span>
                        <span class="n">hitmatrix</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>

        <span class="c"># rule 3:</span>
        <span class="k">if</span><span class="p">(</span><span class="n">scorematrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">scorematrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">hitmatrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">if</span><span class="p">(</span><span class="n">scorematrix</span><span class="p">[</span><span class="n">hei</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="n">wid</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">scorematrix</span><span class="p">[</span><span class="n">hei</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">wid</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">hitmatrix</span><span class="p">[</span><span class="n">hei</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">wid</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>

        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hei</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">wid</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">gtmatrix</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                        <span class="k">print</span> <span class="s">&quot;    &quot;</span><span class="p">,</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&quot;</span><span class="si">%0.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">hitmatrix</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">],</span>
                <span class="k">print</span> <span class="s">&quot;&quot;</span>
            <span class="k">print</span> <span class="s">&quot;&quot;</span>
        <span class="k">return</span> <span class="n">hitmatrix</span>

</div>
<div class="viewcode-block" id="CDMam.detectVarGauss"><a class="viewcode-back" href="../../../../Plugins.MG.Mammo_CDMam.html#Plugins.MG.Mammo_CDMam.CDMam_lib.CDMam.detectVarGauss">[docs]</a>    <span class="k">def</span> <span class="nf">detectVarGauss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span> <span class="n">di</span><span class="p">,</span><span class="n">th</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Blur with Gaussian of sigma matched to diameter of disc == averaging over disc size</span>
<span class="sd">        Detect max response within search radius around expected location</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># Gaussian best sofar</span>
        <span class="c"># mode = 1 # Trace Lxx+Lyy, look for max next best</span>
        <span class="c"># mode = 2 # Det Lxx*Lyy-Lxy*Lyx, look for max</span>

        <span class="n">bbox</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">gridrois</span><span class="p">[</span><span class="n">di</span><span class="p">][</span><span class="n">th</span><span class="p">]</span>
        <span class="n">gt</span>   <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">phantom</span><span class="o">.</span><span class="n">groundtruth</span><span class="p">[</span><span class="n">di</span><span class="p">][</span><span class="n">th</span><span class="p">]</span>
        <span class="n">diam_mm</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">phantom</span><span class="o">.</span><span class="n">diameter_mm</span><span class="p">[</span><span class="n">di</span><span class="p">]</span>
        <span class="n">thick_um</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">phantom</span><span class="o">.</span><span class="n">thickness_um</span><span class="p">[</span><span class="n">th</span><span class="p">]</span>

        <span class="n">scale_mm2pix</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bbox</span><span class="p">)):</span>
            <span class="n">scale_mm2pix</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">bbox</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">bbox</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">bbox</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">scale_mm2pix</span> <span class="o">*=</span> <span class="mf">0.25</span><span class="o">/</span><span class="mf">10.</span>
        <span class="n">rad_px</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">diam_mm</span><span class="o">/</span><span class="mf">2.</span><span class="o">*</span><span class="n">scale_mm2pix</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">minx</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">maxx</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">miny</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">maxy</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bbox</span><span class="p">:</span>
            <span class="n">minx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">maxx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxx</span><span class="p">,</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">miny</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">miny</span><span class="p">,</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">maxy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxy</span><span class="p">,</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">minx</span> <span class="o">-=</span> <span class="n">rad_px</span>
        <span class="n">maxx</span> <span class="o">+=</span> <span class="n">rad_px</span>
        <span class="n">miny</span> <span class="o">-=</span> <span class="n">rad_px</span>
        <span class="n">maxy</span> <span class="o">+=</span> <span class="n">rad_px</span>
        <span class="n">crop</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">pixeldataIn</span><span class="p">[</span><span class="n">minx</span><span class="p">:</span><span class="n">maxx</span><span class="p">,</span><span class="n">miny</span><span class="p">:</span><span class="n">maxy</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="c"># integrate /avg over area</span>
            <span class="n">sigma_px</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span><span class="n">rad_px</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span> <span class="c">#max(1.5,rad_px/6.)</span>
            <span class="n">crop</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">crop</span><span class="p">,</span><span class="n">sigma_px</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="c">#,mode=&#39;constant&#39;)</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">sigma_px</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">3.5</span><span class="p">,</span><span class="n">rad_px</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">Lxx</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">crop</span><span class="p">,</span><span class="n">sigma_px</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="c">#,mode=&#39;constant&#39;)</span>
            <span class="n">Lyy</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">crop</span><span class="p">,</span><span class="n">sigma_px</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">crop</span> <span class="o">=</span> <span class="n">Lxx</span><span class="o">+</span><span class="n">Lyy</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">sigma_px</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">3.5</span><span class="p">,</span><span class="n">rad_px</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">Lxx</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">crop</span><span class="p">,</span><span class="n">sigma_px</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="c">#,mode=&#39;constant&#39;)</span>
            <span class="n">Lyy</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">crop</span><span class="p">,</span><span class="n">sigma_px</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">Lxy</span> <span class="o">=</span> <span class="n">scind</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">crop</span><span class="p">,</span><span class="n">sigma_px</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">crop</span> <span class="o">=</span> <span class="n">Lxx</span><span class="o">*</span><span class="n">Lyy</span><span class="o">-</span><span class="n">Lxy</span><span class="o">*</span><span class="n">Lxy</span>

        <span class="n">offset_mm</span> <span class="o">=</span> <span class="mf">2.85</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span>
        <span class="n">xstep_dx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">offset_mm</span><span class="o">/</span><span class="mf">10.</span><span class="o">*</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">xstep_dy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">offset_mm</span><span class="o">/</span><span class="mf">10.</span><span class="o">*</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">ystep_dx</span> <span class="o">=</span> <span class="o">-</span><span class="n">xstep_dy</span>
        <span class="n">ystep_dy</span> <span class="o">=</span>  <span class="n">xstep_dx</span>
        <span class="c"># search radius</span>
        <span class="n">rad_px</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">.</span><span class="mi">25</span><span class="o">*</span><span class="n">scale_mm2pix</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span><span class="c">#/2 #int(sigma_px+.5) #int(3./4.*scale_mm2pix+.5) # max diam is 3.2 mm</span>
        <span class="n">rad2_px</span> <span class="o">=</span> <span class="n">rad_px</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">minx</span><span class="o">+</span><span class="n">xstep_dx</span><span class="o">+</span><span class="n">ystep_dx</span><span class="p">,</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">miny</span><span class="o">+</span><span class="n">xstep_dy</span><span class="o">+</span><span class="n">ystep_dy</span><span class="p">],</span> <span class="c"># GT =1</span>
            <span class="p">[</span><span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">minx</span><span class="o">-</span><span class="n">xstep_dx</span><span class="o">+</span><span class="n">ystep_dx</span><span class="p">,</span><span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">miny</span><span class="o">-</span><span class="n">xstep_dy</span><span class="o">+</span><span class="n">ystep_dy</span><span class="p">],</span> <span class="c"># GT =2</span>
            <span class="p">[</span><span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">minx</span><span class="o">-</span><span class="n">xstep_dx</span><span class="o">-</span><span class="n">ystep_dx</span><span class="p">,</span><span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">miny</span><span class="o">-</span><span class="n">xstep_dy</span><span class="o">-</span><span class="n">ystep_dy</span><span class="p">],</span> <span class="c"># GT =3</span>
            <span class="p">[</span><span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">minx</span><span class="o">+</span><span class="n">xstep_dx</span><span class="o">-</span><span class="n">ystep_dx</span><span class="p">,</span><span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">miny</span><span class="o">+</span><span class="n">xstep_dy</span><span class="o">-</span><span class="n">ystep_dy</span><span class="p">],</span> <span class="c"># GT =4</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span>   <span class="n">diam_mm</span><span class="p">,</span><span class="n">scale_mm2pix</span><span class="p">,</span> <span class="n">diam_mm</span><span class="o">*</span><span class="n">scale_mm2pix</span><span class="p">,</span> <span class="n">sigma_px</span><span class="p">,</span><span class="n">rad_px</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">if</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">r0</span><span class="o">=</span> <span class="mf">1.e6</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r0</span><span class="o">=</span> <span class="o">-</span><span class="mf">1.e6</span><span class="c"># for trace or det</span>
        <span class="n">response</span> <span class="o">=</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span><span class="n">r0</span><span class="p">,</span><span class="n">r0</span><span class="p">,</span><span class="n">r0</span><span class="p">]</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        GT = 4 1</span>
<span class="sd">             3 2</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">rad_px</span><span class="p">,</span><span class="n">rad_px</span><span class="p">):</span>
                <span class="n">r2my2</span> <span class="o">=</span> <span class="n">rad2_px</span><span class="o">-</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">rad_px</span><span class="p">,</span><span class="n">rad_px</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">r2my2</span><span class="p">:</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="n">response</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">crop</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">y</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">response</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">crop</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">y</span><span class="p">])</span> <span class="c"># for Trace or Det</span>

        <span class="k">if</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">rindex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rindex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="n">rindex</span><span class="p">]</span><span class="o">-</span><span class="n">r0</span><span class="p">)</span> <span class="o">&lt;</span><span class="mf">1.e-6</span><span class="p">:</span> <span class="c"># check if we have an opinion</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="n">score</span><span class="p">[</span><span class="n">rindex</span><span class="p">]</span>

        <span class="k">if</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">guess</span> <span class="o">!=</span> <span class="n">gt</span> <span class="ow">and</span> <span class="n">cs</span><span class="o">.</span><span class="n">plotcount</span><span class="o">&lt;</span><span class="mi">15</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">guimode</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&#39;guess&#39;</span><span class="p">,</span><span class="n">guess</span><span class="p">,</span><span class="n">gt</span><span class="p">,</span>
            <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">score</span><span class="p">,</span><span class="n">response</span><span class="p">):</span>
                <span class="k">print</span> <span class="n">s</span><span class="p">,</span><span class="s">&#39;:&#39;</span><span class="p">,</span><span class="n">r</span><span class="p">,</span>
            <span class="k">print</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="k">if</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">crop</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">response</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">response</span><span class="p">))</span> <span class="c"># (2600.,2800.)</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">crop</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="o">-</span><span class="mf">15.</span><span class="p">,</span><span class="mf">15.</span><span class="p">)</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">crop</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="o">-</span><span class="mf">200.</span><span class="p">,</span><span class="mf">200.</span><span class="p">)</span>

            <span class="c"># black plussed for locations of centers of to look-for locations</span>
            <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;k+&#39;</span><span class="p">)</span>
                <span class="n">circle2</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">rad_px</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle2</span><span class="p">)</span>

            <span class="c"># white plus at location of truth</span>
            <span class="n">pix</span> <span class="o">=</span> <span class="n">gt</span>
            <span class="k">if</span> <span class="n">gt</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">pix</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">pix</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">pos</span><span class="p">[</span><span class="n">pix</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;w+&#39;</span><span class="p">)</span>
            <span class="n">circle2</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">pos</span><span class="p">[</span><span class="n">pix</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">pos</span><span class="p">[</span><span class="n">pix</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span><span class="n">rad_px</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;w&#39;</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle2</span><span class="p">)</span>


            <span class="c"># pink plus at location of max response</span>
            <span class="n">nccloc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">crop</span> <span class="o">==</span> <span class="n">response</span><span class="p">[</span><span class="n">rindex</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nccloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nccloc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;m+&#39;</span><span class="p">)</span>
            <span class="n">circle2</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">nccloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nccloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">rad_px</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;m&#39;</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle2</span><span class="p">)</span>
 
            <span class="c"># pink plus at location of max response</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">diam_mm</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">thick_um</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">plotcount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">hasmadeplots</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># transform into hit or no hit</span>
        <span class="k">if</span> <span class="n">guess</span> <span class="o">==</span> <span class="n">gt</span><span class="p">:</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">guess</span>
</div>
<div class="viewcode-block" id="CDMam.determineScannerID"><a class="viewcode-back" href="../../../../Plugins.MG.Mammo_CDMam.html#Plugins.MG.Mammo_CDMam.CDMam_lib.CDMam.determineScannerID">[docs]</a>    <span class="k">def</span> <span class="nf">determineScannerID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tries to identify machine model, used filter, and energy presentation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dicomfields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s">&quot;0008,1090&quot;</span><span class="p">,</span>  <span class="s">&quot;ModelName&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s">&quot;0018,7050&quot;</span><span class="p">,</span>  <span class="s">&quot;FilterMaterialLT&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s">&quot;0019,10C1&quot;</span><span class="p">,</span>  <span class="s">&quot;MICRODOSE IMAGE CONTENT&quot;</span><span class="p">]</span> <span class="c">#---: SUM FOR PRESENTATION</span>
        <span class="p">]</span>


        <span class="c"># 1. Try to id Scanner</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">scannername</span> <span class="o">=</span> <span class="n">lit</span><span class="o">.</span><span class="n">stUnknown</span>
        <span class="n">dicomvalue</span> <span class="o">=</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">readDICOMtag</span><span class="p">(</span><span class="n">dicomfields</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">cs</span><span class="o">.</span><span class="n">dcmInfile</span><span class="p">)</span> <span class="c"># Manufacturer&#39;s Model Name</span>
        <span class="n">dicomvalue</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dicomvalue</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dicomvalue</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;l50&quot;</span><span class="p">)</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">scannername</span> <span class="o">=</span> <span class="n">lit</span><span class="o">.</span><span class="n">stL50</span>
        <span class="k">elif</span> <span class="n">dicomvalue</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;lorad selenia&quot;</span><span class="p">)</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">guessScanner</span> <span class="o">=</span> <span class="n">lit</span><span class="o">.</span><span class="n">stSelenia</span>
        <span class="k">elif</span> <span class="n">dicomvalue</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;dimensions&quot;</span><span class="p">)</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">guessScanner</span> <span class="o">=</span> <span class="n">lit</span><span class="o">.</span><span class="n">stDimensions</span>

        <span class="c"># 2. Try to id Filter</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">filtername</span> <span class="o">=</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">readDICOMtag</span><span class="p">(</span><span class="n">dicomfields</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">cs</span><span class="o">.</span><span class="n">dcmInfile</span><span class="p">)</span> <span class="c"># Filtername</span>

        <span class="c"># 3. Try to id EnergyPresentation</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">energypresentation</span> <span class="o">=</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">readDICOMtag</span><span class="p">(</span><span class="n">dicomfields</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">cs</span><span class="o">.</span><span class="n">dcmInfile</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="CDMam.DICOMInfo"><a class="viewcode-back" href="../../../../Plugins.MG.Mammo_CDMam.html#Plugins.MG.Mammo_CDMam.CDMam_lib.CDMam.DICOMInfo">[docs]</a>    <span class="k">def</span> <span class="nf">DICOMInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">info</span><span class="o">=</span><span class="s">&#39;dicom&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract some info from the DICOM header. &lt;info&gt; is either &#39;dicom&#39; (extensive list) or &#39;qc&#39; (short list).</span>
<span class="sd">        Returns list of &lt;tag description&gt;,&lt;tag value&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Different from ImageJ version; tags &quot;0008&quot;,&quot;0104&quot; and &quot;0054&quot;,&quot;0220&quot;</span>
        <span class="c">#  appear to be part of sequences. This gives problems (cannot be found</span>
        <span class="c">#  or returning whole sequence blocks)</span>
        <span class="c"># Possibly this can be solved by using if(type(value) == type(dicom.sequence.Sequence()))</span>
        <span class="c">#  but I don&#39;t see the relevance of these tags anymore, so set them to NO</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">determineScannerID</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="s">&quot;dicom&quot;</span><span class="p">):</span>
            <span class="n">dicomfields</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="s">&quot;0008,0021&quot;</span><span class="p">,</span>  <span class="s">&quot;Series Date&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0008,0031&quot;</span><span class="p">,</span>  <span class="s">&quot;Series Time&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0008,0070&quot;</span><span class="p">,</span>  <span class="s">&quot;Manufacturer&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0008,0080&quot;</span><span class="p">,</span>  <span class="s">&quot;InstitutionName&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0008,1010&quot;</span><span class="p">,</span>  <span class="s">&quot;StationName&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0008,1030&quot;</span><span class="p">,</span>  <span class="s">&quot;StudyDescription&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0008,103E&quot;</span><span class="p">,</span>  <span class="s">&quot;SeriesDescription&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0008,1070&quot;</span><span class="p">,</span>  <span class="s">&quot;Operator&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0010,0020&quot;</span><span class="p">,</span>  <span class="s">&quot;PatientID&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0018,0060&quot;</span><span class="p">,</span>  <span class="s">&quot;kVp&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0018,1000&quot;</span><span class="p">,</span>  <span class="s">&quot;DeviceSerialNumber&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0018,1020&quot;</span><span class="p">,</span>  <span class="s">&quot;SoftwareVersions&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0018,1110&quot;</span><span class="p">,</span>  <span class="s">&quot;DistanceSourceToDetector&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0018,1111&quot;</span><span class="p">,</span>  <span class="s">&quot;DistanceSourceToPatient&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0018,1150&quot;</span><span class="p">,</span>  <span class="s">&quot;ExposureTime_(ms)&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0018,1151&quot;</span><span class="p">,</span>  <span class="s">&quot;TubeCurrent_(mA)&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0018,1153&quot;</span><span class="p">,</span>  <span class="s">&quot;muAs&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0018,1164&quot;</span><span class="p">,</span>  <span class="s">&quot;ImagerPixelSpacing&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0018,1166&quot;</span><span class="p">,</span>  <span class="s">&quot;Grid&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0018,1190&quot;</span><span class="p">,</span>  <span class="s">&quot;FocalSpot&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0018,1191&quot;</span><span class="p">,</span>  <span class="s">&quot;AnodeTargetMaterial&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0018,11A0&quot;</span><span class="p">,</span>  <span class="s">&quot;BodyPartThickness&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0018,11A2&quot;</span><span class="p">,</span>  <span class="s">&quot;CompressionForce&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0018,1405&quot;</span><span class="p">,</span>  <span class="s">&quot;RelativeXRayExposure&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0018,700A&quot;</span><span class="p">,</span>  <span class="s">&quot;DetectorID&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0018,700C&quot;</span><span class="p">,</span>  <span class="s">&quot;DateOfLastDetectorCalibration&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0018,7050&quot;</span><span class="p">,</span>  <span class="s">&quot;FilterMaterialLT&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0019,1029&quot;</span><span class="p">,</span>  <span class="s">&quot;---&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0028,0101&quot;</span><span class="p">,</span>  <span class="s">&quot;BitsStored&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0028,1040&quot;</span><span class="p">,</span>  <span class="s">&quot;PixelensityRelationship&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0028,1052&quot;</span><span class="p">,</span>  <span class="s">&quot;Rescaleercept&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0028,1053&quot;</span><span class="p">,</span>  <span class="s">&quot;RescaleSlope&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0028,1054&quot;</span><span class="p">,</span>  <span class="s">&quot;RescaleType&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0040,0302&quot;</span><span class="p">,</span>  <span class="s">&quot;EntranceDose&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0040,0314&quot;</span><span class="p">,</span>  <span class="s">&quot;HalfValueLayer_(mm)&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0040,0316&quot;</span><span class="p">,</span>  <span class="s">&quot;OrganDose&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0040,8302&quot;</span><span class="p">,</span>  <span class="s">&quot;EntranceDose_(mGy)&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0000,0000&quot;</span><span class="p">,</span>  <span class="s">&quot;NOViewCodeSequence&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;0000,0000&quot;</span><span class="p">,</span>  <span class="s">&quot;NOViewCodeMeaning&quot;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">scannername</span> <span class="o">==</span> <span class="n">lit</span><span class="o">.</span><span class="n">stL50</span><span class="p">:</span>
                <span class="n">dicomfields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;0008,0022&quot;</span><span class="p">,</span>  <span class="s">&quot;Acquisition Date&quot;</span><span class="p">]</span>
                <span class="n">dicomfields</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;0008,0030&quot;</span><span class="p">,</span>  <span class="s">&quot;Acquisition Time&quot;</span><span class="p">]</span>

        <span class="k">elif</span><span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="s">&quot;qc&quot;</span><span class="p">):</span>
            <span class="n">dicomfields</span> <span class="o">=</span> <span class="p">[[</span><span class="s">&quot;0008,0021&quot;</span><span class="p">,</span>  <span class="s">&quot;Series Date&quot;</span><span class="p">],</span>
                           <span class="p">[</span><span class="s">&quot;0008,1010&quot;</span><span class="p">,</span>  <span class="s">&quot;StationName&quot;</span><span class="p">],</span>
                           <span class="p">[</span><span class="s">&quot;0008,1070&quot;</span><span class="p">,</span>  <span class="s">&quot;Operator&quot;</span><span class="p">],</span>
                           <span class="p">[</span><span class="s">&quot;0018,0060&quot;</span><span class="p">,</span>  <span class="s">&quot;kVp&quot;</span><span class="p">],</span>
                           <span class="p">[</span><span class="s">&quot;0018,1020&quot;</span><span class="p">,</span>  <span class="s">&quot;SoftwareVersions&quot;</span><span class="p">],</span>
                           <span class="p">[</span><span class="s">&quot;0018,1030&quot;</span><span class="p">,</span>  <span class="s">&quot;ProtocolName&quot;</span><span class="p">],</span>
                           <span class="p">[</span><span class="s">&quot;0018,1110&quot;</span><span class="p">,</span>  <span class="s">&quot;DistanceSourceToDetector&quot;</span><span class="p">],</span>
                           <span class="p">[</span><span class="s">&quot;0018,1111&quot;</span><span class="p">,</span>  <span class="s">&quot;DistanceSourceToPatient&quot;</span><span class="p">],</span>
                           <span class="p">[</span><span class="s">&quot;0018,1153&quot;</span><span class="p">,</span>  <span class="s">&quot;muAs&quot;</span><span class="p">],</span>
                           <span class="p">[</span><span class="s">&quot;0018,1166&quot;</span><span class="p">,</span>  <span class="s">&quot;Grid&quot;</span><span class="p">],</span>
                           <span class="p">[</span><span class="s">&quot;0018,1190&quot;</span><span class="p">,</span>  <span class="s">&quot;FocalSpot&quot;</span><span class="p">],</span>
                           <span class="p">[</span><span class="s">&quot;0018,1191&quot;</span><span class="p">,</span>  <span class="s">&quot;AnodeTargetMaterial&quot;</span><span class="p">],</span>
                           <span class="p">[</span><span class="s">&quot;0018,11A0&quot;</span><span class="p">,</span>  <span class="s">&quot;BodyPartThickness&quot;</span><span class="p">],</span>
                           <span class="p">[</span><span class="s">&quot;0018,11A2&quot;</span><span class="p">,</span>  <span class="s">&quot;CompressionForce&quot;</span><span class="p">],</span>
                           <span class="p">[</span><span class="s">&quot;0018,700A&quot;</span><span class="p">,</span>  <span class="s">&quot;DetectorID&quot;</span><span class="p">],</span>
                           <span class="p">[</span><span class="s">&quot;0018,700C&quot;</span><span class="p">,</span>  <span class="s">&quot;DateOfLastDetectorCalibration&quot;</span><span class="p">],</span>
                           <span class="p">[</span><span class="s">&quot;0018,7050&quot;</span><span class="p">,</span>  <span class="s">&quot;FilterMaterialLT&quot;</span><span class="p">],</span>
                           <span class="p">[</span><span class="s">&quot;0040,0314&quot;</span><span class="p">,</span>  <span class="s">&quot;HalfValueLayer_(mm)&quot;</span><span class="p">],</span>
                           <span class="p">[</span><span class="s">&quot;0040,0316&quot;</span><span class="p">,</span>  <span class="s">&quot;OrganDose&quot;</span><span class="p">],</span>
                           <span class="p">[</span><span class="s">&quot;0040,8302&quot;</span><span class="p">,</span>  <span class="s">&quot;EntranceDose_(mGy)&quot;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">scannername</span> <span class="o">==</span> <span class="n">lit</span><span class="o">.</span><span class="n">stL50</span><span class="p">:</span>
                <span class="n">dicomfields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;0008,0022&quot;</span><span class="p">,</span>  <span class="s">&quot;Acquisition Date&quot;</span><span class="p">]</span>
                <span class="n">dicomfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span><span class="s">&quot;0019,10c1&quot;</span><span class="p">,</span>  <span class="s">&quot;EnergyComponent&quot;</span><span class="p">]</span> <span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dicomfields</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">wadwrapper_lib</span><span class="o">.</span><span class="n">readDICOMtag</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">cs</span><span class="o">.</span><span class="n">dcmInfile</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">value</span><span class="p">)</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>
</pre></div></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">..  documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Author.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.1.
    </div>
  </body>
</html>